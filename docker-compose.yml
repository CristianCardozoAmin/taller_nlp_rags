version: "3.9"

services:
  solr:
    image: solr:9
    container_name: solr
    command:
      - solr-precreate
      - rag
    ports:
      - "8983:8983"
    volumes:
      - ./services/solr:/var/solr
    restart: unless-stopped

  milvus:
    image: milvusdb/milvus:v2.4.0
    container_name: milvus
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_USE_EMBED: "true"
      MINIO_USE_EMBED: "true"
      COMMON_STORAGETYPE: "local"
    ports:
      - "19530:19530"   # gRPC
      - "9091:9091"     # HTTP/monitoring
    volumes:
      - ./services/milvus:/var/lib/milvus
    restart: unless-stopped

  api:
    build: ./services/api
    container_name: rag_api
    depends_on:
      - solr
      - milvus
    environment:
      SOLR_URL: "http://solr:8983/solr/rag"
      MILVUS_HOST: "milvus"
      MILVUS_PORT: "19530"
      MILVUS_COLLECTION: "rag_collection"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      OPENAI_MODEL: "gpt-5-mini"
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
    restart: unless-stopped

  indexer:
    build: ./services/indexer
    container_name: rag_indexer
    depends_on:
      - solr
      - milvus
    environment:
      CSV_PATH: "/app/data/corpus"
      SOLR_URL: "http://solr:8983/solr/rag"
      MILVUS_HOST: "milvus"
      MILVUS_PORT: "19530"
      MILVUS_COLLECTION: "rag_collection"
    volumes:
      - ./data:/app/data
    restart: "no"

  evaluator:
    build: ./services/evaluator
    container_name: rag_evaluator
    depends_on:
      - api
    environment:
      API_URL: "http://api:8000"
      REPORT_DIR: "/app/reports"
      EVAL_FILE: "/app/data/eval_queries.json"
    volumes:
      - ./reports:/app/reports
      - ./data:/app/data
    restart: "no"
